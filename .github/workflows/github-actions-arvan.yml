# Script environment variables
env:
    DOCKER_IMAGE_NAME: iplocator
    DOCKER_REGISTRY: docker.io/devotem
name: Build and Push Docker Image
  
# Triggers
on:
    workflow_dispatch:
    push:
        branches:
            - main
  
jobs:
    build-and-push-landing-page:
      name: Build and Push Docker Image
      runs-on: self-hosted
  
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
  
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3
  
        - name: Login to Docker Registry
          uses: docker/login-action@v3
          with:
            registry: ${{ env.DOCKER_REGISTRY }}
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

        - name: Set outputs
          id: vars
          run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        - name: Check outputs
          run: echo ${{ steps.vars.outputs.sha_short }}
  
  
        - name: Build and push Landing Page Docker image
          uses: docker/build-push-action@v6
          with:
            context: .
            file: ./dockerfile
            push: true
            tags: |
              ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}:${{ steps.vars.outputs.sha_short }}

        
        - name: Update ip-locator.yml with new image tag
          run: |
              sed -i "s|image:.*|image: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}:${{ steps.vars.outputs.sha_short }}|" ip-locator.yml
              cat ip-locator.yml

        - name: Copy manifest to master and apply
          uses: appleboy/ssh-action@v0.1.7
          with:
                host: ${{ secrets.K8S_MASTER_IP }}
                username: ${{ secrets.K8S_USER }}
                script: |
                  export KUBECONFIG=/etc/kubernetes/admin.conf
                  kubectl apply -f /tmp/ip-locator.yml
                  kubectl get pods
                pre-command: scp ip-locator.yml ${{ secrets.K8S_USER }}@${{ secrets.K8S_MASTER_IP }}:/tmp/ip-locator.yml